<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Live Stream Scheduler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #333;
            margin-bottom: 5px;
        }
        .header p {
            color: #666;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .status-streaming { background: #10b981; color: white; }
        .status-stopped { background: #ef4444; color: white; }
        .status-downloading { background: #f59e0b; color: white; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #666; font-weight: 500; }
        .info-value { color: #333; font-weight: 600; }
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            line-height: 1.5;
        }
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .time-display {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üé• StreamLive Admin Dashboard</h1>
                    <p>‚ú® Kelola live streaming YouTube dengan mudah dan profesional</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #666;">üë§ {{ user.username }}</span>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="text-decoration: none;">
                        üö™ Logout
                    </a>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üé¨ Video Library</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="showUploadVideoModal()">üì§ Upload Video</button>
                <button class="btn btn-warning" onclick="showDownloadVideoModal()">‚¨áÔ∏è Download dari GDrive</button>
                <button class="btn btn-secondary" onclick="scanLocalVideos()">üîç Scan Folder Videos</button>
            </div>
            <div id="videos-container" style="max-height: 400px; overflow-y: auto;">
                <div class="info-row">Loading videos...</div>
            </div>
        </div>

        <div class="card">
            <h2>üì∫ Channels</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="showAddChannelModal()">‚ûï Tambah Channel</button>
                <button class="btn btn-danger" onclick="stopAllStreams()">‚èπÔ∏è Stop Semua</button>
            </div>
            <div id="channels-container">
                <div class="info-row">Loading channels...</div>
            </div>
        </div>

        <div id="add-channel-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 10px; max-height: 80vh; overflow-y: auto;">
                <h2>‚ûï Tambah Channel Baru</h2>
                <form id="add-channel-form" onsubmit="addChannel(event)">
                    <div class="form-group">
                        <label>Nama Channel:</label>
                        <input type="text" id="new_channel_name" required>
                    </div>
                    <div class="form-group">
                        <label>YouTube Stream Key:</label>
                        <input type="password" id="new_stream_key" required>
                    </div>
                    <div class="form-group">
                        <label>Pilih Video:</label>
                        <select id="new_video_id" onchange="selectVideo()" required>
                            <option value="">-- Pilih dari Video Library --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Path Video:</label>
                        <input type="text" id="new_video_path" readonly style="background: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Mulai Campaign (Opsional):</label>
                        <input type="date" id="new_start_date">
                        <small style="color: #666;">Kosongkan jika ingin mulai sekarang</small>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Selesai Campaign (Opsional):</label>
                        <input type="date" id="new_end_date">
                        <small style="color: #666;">Kosongkan jika tidak ada batas waktu</small>
                    </div>
                    <div class="form-group">
                        <label>Waktu Mulai (Harian):</label>
                        <input type="time" id="new_start_time" value="08:00" required>
                    </div>
                    <div class="form-group">
                        <label>Waktu Selesai (Harian):</label>
                        <input type="time" id="new_end_time" value="20:00" required>
                    </div>
                    <div class="form-group">
                        <label>Timezone:</label>
                        <select id="new_timezone">
                            <option value="Asia/Jakarta">WIB (Jakarta)</option>
                            <option value="Asia/Makassar">WITA (Makassar)</option>
                            <option value="Asia/Jayapura">WIT (Jayapura)</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f3f4f6; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="show_advanced" onchange="toggleAdvanced()" style="margin-right: 10px;">
                            <strong>‚öôÔ∏è Advanced Settings (Opsional)</strong>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Default: Streaming menggunakan kualitas video asli tanpa re-encode
                        </small>
                    </div>
                    
                    <div id="advanced_settings" style="display: none;">
                        <div class="form-group">
                            <label>Encoding Mode:</label>
                            <select id="new_encoding_mode" onchange="toggleEncodingOptions()">
                                <option value="copy" selected>Copy (Gunakan video asli - Recommended)</option>
                                <option value="encode">Re-encode (Custom bitrate & FPS)</option>
                            </select>
                            <small style="color: #666;">Copy = Cepat & hemat CPU. Re-encode = Custom quality tapi butuh CPU lebih</small>
                        </div>
                        
                        <div id="encoding_options" style="display: none;">
                            <div class="form-group">
                                <label>Bitrate:</label>
                                <input type="text" id="new_bitrate" value="4000k" placeholder="4000k">
                                <small style="color: #666;">Contoh: 2500k (720p), 4000k (1080p), 6000k (1080p60)</small>
                            </div>
                            <div class="form-group">
                                <label>FPS (Frame Per Second):</label>
                                <input type="number" id="new_fps" value="30" min="24" max="60">
                            </div>
                            <div class="form-group">
                                <label>Preset:</label>
                                <select id="new_preset">
                                    <option value="ultrafast">Ultrafast (CPU rendah, quality rendah)</option>
                                    <option value="veryfast" selected>Veryfast (Balanced)</option>
                                    <option value="fast">Fast (CPU sedang, quality bagus)</option>
                                    <option value="medium">Medium (CPU tinggi, quality terbaik)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Simpan</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddChannelModal()">‚ùå Batal</button>
                </form>
            </div>
        </div>

        <!-- Upload Video Modal -->
        <div id="upload-video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 10px;">
                <h2>üì§ Upload Video</h2>
                <form id="upload-video-form" onsubmit="uploadVideo(event)">
                    <div class="form-group">
                        <label>Judul Video:</label>
                        <input type="text" id="upload_video_title" required>
                    </div>
                    <div class="form-group">
                        <label>Pilih File Video:</label>
                        <input type="file" id="upload_video_file" accept="video/*" required>
                        <small style="color: #666;">Format: MP4, MKV, AVI, MOV, dll. Max: 2GB</small>
                    </div>
                    <div id="upload-progress" style="display: none; margin: 15px 0;">
                        <div style="background: #e5e7eb; border-radius: 10px; height: 30px; overflow: hidden;">
                            <div id="upload-progress-bar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                0%
                            </div>
                        </div>
                        <small id="upload-status" style="color: #666; display: block; margin-top: 5px;">Preparing upload...</small>
                    </div>
                    <button type="submit" class="btn btn-primary" id="upload-btn">üì§ Upload</button>
                    <button type="button" class="btn btn-secondary" onclick="hideUploadVideoModal()">‚ùå Batal</button>
                </form>
            </div>
        </div>

        <!-- Download Video from GDrive Modal -->
        <div id="download-video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 10px;">
                <h2>‚¨áÔ∏è Download dari Google Drive</h2>
                <form id="download-video-form" onsubmit="downloadVideoGDrive(event)">
                    <div class="form-group">
                        <label>Judul Video:</label>
                        <input type="text" id="gdrive_video_title" required>
                    </div>
                    <div class="form-group">
                        <label>Nama File (akan disimpan):</label>
                        <input type="text" id="gdrive_video_filename" placeholder="video.mp4" required>
                    </div>
                    <div class="form-group">
                        <label>Google Drive File ID:</label>
                        <input type="text" id="gdrive_video_id" required>
                        <small style="color: #666;">Dari link: drive.google.com/file/d/<strong>FILE_ID</strong>/view</small>
                    </div>
                    <button type="submit" class="btn btn-warning">‚¨áÔ∏è Download</button>
                    <button type="button" class="btn btn-secondary" onclick="hideDownloadVideoModal()">‚ùå Batal</button>
                </form>
            </div>
        </div>

        <div class="card">
            <h2>üìù Logs</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry">Menunggu aktivitas...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä Statistik</h2>
                <div id="stats-container">
                    <div class="info-row">
                        <span class="info-label">Total Sessions:</span>
                        <span class="info-value" id="total-sessions">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Durasi:</span>
                        <span class="info-value" id="total-duration">0h 0m</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìú History (5 Terakhir)</h2>
                <div id="history-container" style="max-height: 200px; overflow-y: auto;">
                    <div class="info-row">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateChannels() {
            fetch('/api/channels')
                .then(r => r.json())
                .then(data => {
                    fetch('/api/status')
                        .then(r => r.json())
                        .then(statusData => {
                            const container = document.getElementById('channels-container');
                            if (data.channels.length === 0) {
                                container.innerHTML = '<div class="info-row">Belum ada channel. Tambah channel baru!</div>';
                                return;
                            }
                            
                            container.innerHTML = data.channels.map(channel => {
                                const channelStatus = statusData.channels.find(c => c.id === channel.id);
                                const isRunning = channelStatus ? channelStatus.running : false;
                                const statusBadge = isRunning 
                                    ? '<span class="status-badge status-streaming">Streaming</span>'
                                    : '<span class="status-badge status-stopped">Stopped</span>';
                                
                                // Format date range
                                let dateRange = '';
                                if (channel.start_date || channel.end_date) {
                                    const startDate = channel.start_date ? new Date(channel.start_date).toLocaleDateString('id-ID') : 'Sekarang';
                                    const endDate = channel.end_date ? new Date(channel.end_date).toLocaleDateString('id-ID') : 'Tanpa batas';
                                    dateRange = `
                                        <div class="info-row">
                                            <span class="info-label">Periode:</span>
                                            <span class="info-value">${startDate} - ${endDate}</span>
                                        </div>
                                    `;
                                }
                                
                                // Check if campaign is active
                                let campaignStatus = '';
                                const today = new Date().toISOString().split('T')[0];
                                if (channel.start_date && today < channel.start_date) {
                                    campaignStatus = '<small style="color: #f59e0b;">‚è≥ Belum dimulai</small>';
                                } else if (channel.end_date && today > channel.end_date) {
                                    campaignStatus = '<small style="color: #ef4444;">‚èπÔ∏è Campaign selesai</small>';
                                } else if (channel.start_date || channel.end_date) {
                                    campaignStatus = '<small style="color: #10b981;">‚úÖ Campaign aktif</small>';
                                }
                                
                                return `
                                    <div class="card" style="margin-bottom: 15px; background: #f9fafb;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div>
                                                <h3 style="margin: 0;">${channel.name}</h3>
                                                ${campaignStatus}
                                            </div>
                                            ${statusBadge}
                                        </div>
                                        ${dateRange}
                                        <div class="info-row">
                                            <span class="info-label">Jadwal Harian:</span>
                                            <span class="info-value">${channel.start_time} - ${channel.end_time}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Video:</span>
                                            <span class="info-value">${channelStatus && channelStatus.video_exists ? '‚úÖ Ada' : '‚ùå Belum ada'}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Mode:</span>
                                            <span class="info-value">${channel.encoding_mode === 'copy' ? 'üìã Copy (Original)' : `üé¨ Encode (${channel.bitrate}, ${channel.fps}fps)`}</span>
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <button class="btn btn-success btn-sm" onclick="startChannel(${channel.id})" ${isRunning ? 'disabled' : ''}>‚ñ∂Ô∏è Start</button>
                                            <button class="btn btn-danger btn-sm" onclick="stopChannel(${channel.id})" ${!isRunning ? 'disabled' : ''}>‚èπÔ∏è Stop</button>
                                            <button class="btn btn-secondary btn-sm" onclick="deleteChannel(${channel.id})" ${isRunning ? 'disabled' : ''}>üóëÔ∏è Hapus</button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        });
                });
        }

        function updateLogs() {
            fetch('/api/logs')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('log-container');
                    container.innerHTML = data.logs.map(log => 
                        `<div class="log-entry">${log}</div>`
                    ).join('') || '<div class="log-entry">Tidak ada log</div>';
                    container.scrollTop = container.scrollHeight;
                });
        }

        function updateStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('total-sessions').textContent = data.total_sessions;
                    const hours = Math.floor(data.total_duration_seconds / 3600);
                    const minutes = Math.floor((data.total_duration_seconds % 3600) / 60);
                    document.getElementById('total-duration').textContent = `${hours}h ${minutes}m`;
                });
        }

        function updateHistory() {
            fetch('/api/history?limit=5')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('history-container');
                    if (data.sessions.length === 0) {
                        container.innerHTML = '<div class="info-row">Belum ada history</div>';
                        return;
                    }
                    container.innerHTML = data.sessions.map(s => {
                        const startTime = new Date(s.start_time).toLocaleString('id-ID');
                        const statusIcon = s.status === 'stopped' ? '‚úÖ' : s.status === 'started' ? '‚ñ∂Ô∏è' : '‚ùå';
                        return `
                            <div class="info-row">
                                <span class="info-label">${statusIcon} ${startTime}</span>
                                <span class="info-value">${s.duration_formatted}</span>
                            </div>
                        `;
                    }).join('');
                });
        }

        function showAddChannelModal() {
            document.getElementById('add-channel-modal').style.display = 'block';
            // Refresh video list when modal opens
            updateVideos();
        }

        function hideAddChannelModal() {
            document.getElementById('add-channel-modal').style.display = 'none';
            selectedVideoId = null; // Reset selection when closing
        }

        function toggleAdvanced() {
            const checkbox = document.getElementById('show_advanced');
            const advancedDiv = document.getElementById('advanced_settings');
            advancedDiv.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleEncodingOptions() {
            const mode = document.getElementById('new_encoding_mode').value;
            const optionsDiv = document.getElementById('encoding_options');
            optionsDiv.style.display = mode === 'encode' ? 'block' : 'none';
        }

        let selectedVideoId = null;

        function selectVideo() {
            const videoId = document.getElementById('new_video_id').value;
            selectedVideoId = videoId;
            
            if (!videoId) {
                document.getElementById('new_video_path').value = '';
                return;
            }
            
            fetch(`/api/videos/${videoId}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('new_video_path').value = data.video.file_path;
                });
        }

        function addChannel(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('new_start_date').value;
            const endDate = document.getElementById('new_end_date').value;
            
            // Validate dates
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                alert('‚ùå Tanggal mulai tidak boleh lebih besar dari tanggal selesai!');
                return;
            }
            
            const channel = {
                name: document.getElementById('new_channel_name').value,
                stream_key: document.getElementById('new_stream_key').value,
                video_path: document.getElementById('new_video_path').value,
                start_date: startDate || null,
                end_date: endDate || null,
                start_time: document.getElementById('new_start_time').value,
                end_time: document.getElementById('new_end_time').value,
                timezone: document.getElementById('new_timezone').value,
                encoding_mode: document.getElementById('new_encoding_mode').value,
                bitrate: document.getElementById('new_bitrate').value,
                fps: parseInt(document.getElementById('new_fps').value),
                preset: document.getElementById('new_preset').value
            };
            
            if (!channel.video_path) {
                alert('‚ùå Pilih video dari library dulu!');
                return;
            }
            
            fetch('/api/channels', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(channel)
            })
            .then(r => r.json())
            .then(data => {
                alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
                if (data.success) {
                    hideAddChannelModal();
                    updateChannels();
                    document.getElementById('add-channel-form').reset();
                    selectedVideoId = null; // Reset selected video
                }
            });
        }

        function updateVideos() {
            fetch('/api/videos')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('videos-container');
                    const select = document.getElementById('new_video_id');
                    
                    if (data.videos.length === 0) {
                        container.innerHTML = '<div class="info-row">Belum ada video. Tambah video baru!</div>';
                        select.innerHTML = '<option value="">-- Belum ada video --</option>';
                        return;
                    }
                    
                    // Update video list
                    container.innerHTML = data.videos.map(video => `
                        <div class="info-row">
                            <div>
                                <strong>${video.title}</strong><br>
                                <small style="color: #666;">
                                    ${video.resolution || 'Unknown'} ‚Ä¢ ${video.duration_formatted} ‚Ä¢ ${video.file_size_mb} MB
                                    ${video.usage_count > 0 ? ` ‚Ä¢ Digunakan ${video.usage_count}x` : ''}
                                </small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteVideo(${video.id})">üóëÔ∏è</button>
                        </div>
                    `).join('');
                    
                    // Update select options and preserve selection
                    const currentValue = selectedVideoId || select.value;
                    select.innerHTML = '<option value="">-- Pilih dari Video Library --</option>' +
                        data.videos.map(v => {
                            const selected = v.id == currentValue ? 'selected' : '';
                            return `<option value="${v.id}" ${selected}>${v.title} (${v.file_size_mb}MB)</option>`;
                        }).join('');
                    
                    // Restore selection if exists
                    if (currentValue) {
                        select.value = currentValue;
                    }
                });
        }

        function showUploadVideoModal() {
            document.getElementById('upload-video-modal').style.display = 'block';
        }

        function hideUploadVideoModal() {
            document.getElementById('upload-video-modal').style.display = 'none';
            document.getElementById('upload-video-form').reset();
            document.getElementById('upload-progress').style.display = 'none';
        }

        function showDownloadVideoModal() {
            document.getElementById('download-video-modal').style.display = 'block';
        }

        function hideDownloadVideoModal() {
            document.getElementById('download-video-modal').style.display = 'none';
        }

        function uploadVideo(e) {
            e.preventDefault();
            
            const title = document.getElementById('upload_video_title').value;
            const fileInput = document.getElementById('upload_video_file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ùå Pilih file video dulu!');
                return;
            }
            
            // Check file size (max 2GB)
            if (file.size > 2 * 1024 * 1024 * 1024) {
                alert('‚ùå File terlalu besar! Maksimal 2GB');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('title', title);
            
            // Show progress
            document.getElementById('upload-progress').style.display = 'block';
            document.getElementById('upload-btn').disabled = true;
            
            const xhr = new XMLHttpRequest();
            
            // Progress handler
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressBar = document.getElementById('upload-progress-bar');
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    document.getElementById('upload-status').textContent = 
                        `Uploading... ${(e.loaded / 1024 / 1024).toFixed(2)} MB / ${(e.total / 1024 / 1024).toFixed(2)} MB`;
                }
            });
            
            // Complete handler
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    alert('‚úÖ ' + response.message);
                    hideUploadVideoModal();
                    updateVideos();
                } else {
                    const response = JSON.parse(xhr.responseText);
                    alert('‚ùå ' + (response.message || 'Upload gagal'));
                }
                document.getElementById('upload-btn').disabled = false;
            });
            
            // Error handler
            xhr.addEventListener('error', () => {
                alert('‚ùå Upload error!');
                document.getElementById('upload-btn').disabled = false;
            });
            
            xhr.open('POST', '/api/videos/upload');
            xhr.send(formData);
        }

        function scanLocalVideos() {
            if (confirm('Scan folder ./videos untuk menemukan video yang belum terdaftar?')) {
                fetch('/api/videos/scan', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert(`‚úÖ ${data.message}\n\nDitemukan: ${data.found} video\nDitambahkan: ${data.added} video baru`);
                            updateVideos();
                        } else {
                            alert('‚ùå ' + data.message);
                        }
                    });
            }
        }

        function downloadVideoGDrive(e) {
            e.preventDefault();
            const video = {
                title: document.getElementById('gdrive_video_title').value,
                filename: document.getElementById('gdrive_video_filename').value,
                gdrive_file_id: document.getElementById('gdrive_video_id').value
            };
            
            fetch('/api/videos/download-gdrive', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(video)
            })
            .then(r => r.json())
            .then(data => {
                alert('‚úÖ ' + data.message);
                hideDownloadVideoModal();
                document.getElementById('download-video-form').reset();
                setTimeout(updateVideos, 2000);
            });
        }

        function deleteVideo(videoId) {
            if (confirm('Hapus video dari library? File akan dihapus permanen!')) {
                fetch(`/api/videos/${videoId}`, {method: 'DELETE'})
                    .then(r => r.json())
                    .then(data => {
                        alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
                        if (data.success) updateVideos();
                    });
            }
        }

        function startChannel(channelId) {
            fetch(`/api/start/${channelId}`, {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
                    updateChannels();
                });
        }

        function stopChannel(channelId) {
            fetch(`/api/stop/${channelId}`, {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
                    updateChannels();
                });
        }

        function stopAllStreams() {
            if (confirm('Stop semua streaming yang berjalan?')) {
                fetch('/api/stop-all', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        alert('‚úÖ ' + data.message);
                        updateChannels();
                    });
            }
        }

        function deleteChannel(channelId) {
            if (confirm('Hapus channel ini? (Video tidak akan dihapus)')) {
                fetch(`/api/channels/${channelId}`, {method: 'DELETE'})
                    .then(r => r.json())
                    .then(data => {
                        alert(data.success ? '‚úÖ ' + data.message : '‚ùå ' + data.message);
                        updateChannels();
                    });
            }
        }

        // Section Management
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            // Show selected section
            document.getElementById('section-' + section).style.display = 'block';
            
            // Add active class to clicked menu item
            event.target.closest('.menu-item').classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'channels': 'Channels Management',
                'videos': 'Video Library',
                'logs': 'System Logs',
                'stats': 'Statistics'
            };
            document.getElementById('page-title').textContent = titles[section];
        }

        // Update Dashboard Stats
        function updateDashboardStats() {
            fetch('/api/channels')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('stat-channels').textContent = data.channels ? data.channels.length : 0;
                });
            
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('stat-running').textContent = data.total_running || 0;
                });
            
            fetch('/api/videos')
                .then(r => r.json())
                .then(data => {
                    const videos = data.videos || [];
                    document.getElementById('stat-videos').textContent = videos.length;
                    
                    // Calculate total storage
                    const totalSize = videos.reduce((sum, v) => sum + (v.file_size_mb || 0), 0);
                    document.getElementById('stat-storage').textContent = (totalSize / 1024).toFixed(2) + 'GB';
                });
            
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('stat-sessions').textContent = data.total_sessions || 0;
                    const hours = Math.floor((data.total_duration_seconds || 0) / 3600);
                    document.getElementById('stat-duration').textContent = hours + 'h';
                });
        }

        // Update setiap beberapa detik
        setInterval(updateChannels, 3000);
        setInterval(updateVideos, 5000);
        setInterval(updateLogs, 3000);
        setInterval(updateStats, 5000);
        setInterval(updateHistory, 5000);
        setInterval(updateDashboardStats, 5000);
        
        // Initial load
        updateChannels();
        updateVideos();
        updateLogs();
        updateStats();
        updateHistory();
        updateDashboardStats();
    </script>
</body>
</html>
